#!/bin/bash

SESSION_FILE_DEFAULT="./session"

DBG=false

main()
{
    local session_files=("${@}")
    [ ${#session_files[@]} -eq 0 ] && session_files=("${SESSION_FILE_DEFAULT}")

    local vim_files=($(parse_session_files "${session_files[@]}"))

    local cmd="TERM=screen-256color vim -- $(echo "${vim_files[@]}")" || return ${?}
    ${DBG} && echo "${cmd}" >&2 || eval ${cmd}

    return 0
}

#
# Parse multiple sessions files for file paths.
#
parse_session_files()
{
    local files=("${@}")
    local file
    for file in "${files[@]}"
    do
        parse_session_file "${file}"
    done
    return 0
}

#
# Parse single sessions file (possibly nested) for file paths.
#
parse_session_file()
{
    local file="${1}"
    local path="${2}"
    local sub_file
    local sub_path
    local line
    ${DBG} && echo "F '${file}'" >&2
    while read line
    do
        ${DBG} && echo "> '${line}'" >&2
        if [ "${line:0:1}" == '<' ]
        then
            sub_file="$(echo "${line:1}" | sed 's/^ \+//')"
            sub_path="$(dirname "${sub_file}")"
            ${DBG} && echo "  sub_file : ${sub_file}" >&2
            ${DBG} && echo "  sub_path : ${sub_path}" >&2
            parse_session_file "${sub_file}" "${sub_path}"
        else
            parse_session_line "${line}" "${path}"
        fi
    done < "${file}"
    return 0
}

#
# Parse a line in a sessions file for file paths.
#
parse_session_line()
{
    local line="${1}"
    local path="${2}"
    line="$(echo "${line}" | sed -e 's/^ \+//' -e 's/#.*$//')"
    [ "${line}" == '' ] && return 0
    [ "${path}" == '' ] && path='.'
    local file="$(echo "${path}/${line}" | sed -e 's@\./@@' -e 's@/./@/@g')"
    echo "${file}"
    return 0
}

main "$@"
